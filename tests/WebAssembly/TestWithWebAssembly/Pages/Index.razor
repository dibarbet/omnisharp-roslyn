@page "/"
@using OmniSharp.WebAssembly
@using System.Text.RegularExpressions
@using System.Web

<PageTitle>Index</PageTitle>

<h1>Hello, world!</h1>

<InputFile OnChange="@LoadFiles" multiple />


<p>
    @foreach (var line in Text)
    {
        <br />
        @((MarkupString)Regex.Replace(
            HttpUtility.HtmlEncode(@line), "\r?\n|\r", "<br />"))
    }
</p>

@code
{
    public List<string> Text { get; } = new List<string>();

    private async Task LoadFiles(InputFileChangeEventArgs e)
    {
        var memoryStream = new MemoryStream();
        var stream = e.File.OpenReadStream(maxAllowedSize: 2147483648);
        await stream.CopyToAsync(memoryStream);
        var response = await OmniSharp.WebAssembly.Host.InitializeAsync(memoryStream.ToArray(), new RazorLoggerProvider(this));
        new RazorLogger(this, "Result").LogInformation(response);
    }

    class RazorLoggerProvider : ILoggerProvider
    {
        private readonly Index _page;
        public RazorLoggerProvider(Index page)
        {
            _page = page;
        }

        public ILogger CreateLogger(string categoryName)
        {
            return new RazorLogger(_page, categoryName);
        }

        public void Dispose()
        {
        }
    }

    class RazorLogger : ILogger
    {
        private readonly string _categoryName;
        private readonly Index _page;

        public RazorLogger(Index page, string categoryName)
        {
            _categoryName = categoryName;
            _page = page;
        }

        public IDisposable BeginScope<TState>(TState state)
        {
            return NullScope.Instance;
        }

        public bool IsEnabled(LogLevel logLevel)
        {
            return true;
        }

        public void Log<TState>(LogLevel logLevel, EventId eventId, TState state, Exception? exception, Func<TState, Exception?, string> formatter)
        {
            if (exception != null)
            {
                _page.Text.Add($"[{logLevel}][{_categoryName}]{formatter(state, exception)}{Environment.NewLine}Exception:{exception}");
            }
            else if (eventId == default)
            {
                _page.Text.Add($"[{logLevel}][{_categoryName}]{formatter(state, exception)}");
            }
            else
            {
                _page.Text.Add($"[{logLevel}][{_categoryName}][{eventId}]{formatter(state, exception)}");
            }
            _page.StateHasChanged();
        }
    }

}
